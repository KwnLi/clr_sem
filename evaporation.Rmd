---
title: "evaporation"
author: "Kevin Li"
date: "10/26/2021"
output: html_document
---

```{r setup, message= FALSE}

library(tidyverse)
library(lubridate)
library(egg)
library(mgcv)
library(mixedup)

```

## Evaporation data from raw

Just exploring evaporation starting from raw data. First combine the control and plot data into one unified dataset with time and date. 

```{r combine_raw}
evap <- read.csv("./data/evap_raw.csv")
evap_ctrl <- read.csv("./data/evap_control.csv")
rain <- readRDS("Data/dailyrain.rds")

evap_all <- evap %>% select(date:evpRate_g.mm2.s) %>%
  filter(paperID != "") %>%
  bind_rows(
    evap_ctrl %>% select(date:evpRate_g.mm2.s) %>%
      filter(startTime != "") %>%
      rename(paperID = ID)
  ) %>%
  mutate(startTime = as.POSIXlt(paste(date, startTime, sep = ":"), 
                             format = "%m/%d/%Y:%H:%M:%S")) %>% # I convert the time and date columns to r formats
  mutate(endTime = as.POSIXlt(paste(date, endTime, sep = ":"), 
                             format = "%m/%d/%Y:%H:%M:%S")) %>%
  mutate(date = as.Date(date, "%m/%d/%Y")) %>%
  rowwise() %>% 
  mutate(dateTime = mean(c(startTime, endTime))) %>% # the date/time at the center of the drying period
  ungroup() %>%
  mutate(decTime = hour(dateTime) + minute(dateTime)/60 + second(dateTime)/3600) %>% # the decimal time at the center of the drying period
  mutate(evapRate_ng = ifelse(evpRate_g.mm2.s > 0, evpRate_g.mm2.s*1e9, 1)) %>%  # evaporation rate in nanograms, so the units aren't so small
  mutate(locID = factor(ifelse(is.na(plotID), type, plotID))) %>%  # locID and locType are just to help with plotting
  mutate(locType = ifelse(is.na(plotID), type, "plot")) %>%
  mutate(dateFac = factor(date)) %>%
  mutate(dateNum = as.numeric(date - as.Date("05/30/2016", "%m/%d/%Y"))) %>%
  left_join(rain %>% 
              mutate(rain_lag = dplyr::lag(rain_mm, order_by = date)) %>%
              select(date, rain_mm, rain_lag))
```

## Plot some of the data

```{r loess_date, message=FALSE}
ggplot(evap_all, 
       aes(date, evapRate_ng, color = plotID, shape = locType, group = locType)) + 
  geom_point() + geom_smooth() + 
  scale_shape_manual(values = c(0:2, 19)) + 
  scale_color_distiller(palette = "Spectral") + 
  facet_wrap(~ locType)

```

Here I plot the three control datasets separately and all the plots together against the dates. I fit a LOESS smoothing to the data, which is like a moving window type of analysis, as I understand it. These are the raw data points, not averages.

### Mean evaporation rate by date

```{r spaghetti_mn}
ggplot(evap_all %>% group_by(date, locID, plotID, locType) %>% 
         summarize(evap_mn = mean(evapRate_ng)), 
       aes(date, evap_mn, color = plotID, shape = locType, group = locID)) + 
  geom_line() + geom_point() +
  scale_shape_manual(values = c(0:2, 19)) + 
  scale_color_distiller(palette = "Spectral") + 
  facet_wrap(~ locType)
```

I've taken the mean of the evaporation rate on each date, by plot or control location. Individual plots or control points are connected by a line.

### Time of day

```{r gam_time}
ggplot(evap_all, 
       aes(decTime, evapRate_ng, color = plotID, shape = locType, group = locType)) + 
  geom_point() + geom_smooth(method = "gam") + 
  scale_shape_manual(values = c(0:2, 19)) + 
  scale_color_distiller(palette = "Spectral") + 
  facet_wrap(~ locType)
```

I've fit a GAM to the raw (unaveraged) data over time of day over the control locations and the plots (taken together)

### Time of day, over months

```{r gam_time_month}

ggplot(evap_all %>% mutate(month = month(date)), 
       aes(decTime, evapRate_ng, color = locType, shape = locType)) + 
  geom_point() + geom_smooth(method = "gam") + 
  scale_shape_manual(values = c(0:2, 19)) + 
  facet_wrap(~ month) + theme_article()

```

I've fit a GAM over time for control locations or plots, but separately by months, to see if the nonlinear relationship changes over time.

## Model

First attempt at a model. The effect of time is fit as a spline and the effects of date are random effects.

```{r first_gam}

m1 <- gam(evapRate_ng ~ s(decTime, k = 8, m = 2) + 
            s(dateFac, bs = "re", k = 34) + 
            s(locID, bs = "re", k = 131),
          data = evap_all, method = "REML", family = "gaussian")

plot(m1)

gam.check(m1)

summary(m1)


```

Based on the tests in the GAM check function, this model may not have allowed for enough "wiggliness" in the trend over time of day. However when I try to increase the degrees of freedom, the estimated shape does not seem right (there is an overall curve as seen here but also small curves that probably are accounting for variability due to differences between locations rather than time of day).

In model 1 I treated each separate day as independent, i.e., the same day has the same effect on evaporation, but there isn't a multi-day trend. In model 2 I treat days as a continuous variable and fit a nonlinear relationship to evaporation. It doesn't perform as well as treating days separately.

```{r model2}

m2 <- gam(evapRate_ng ~ s(decTime, k = 10, m = 2) + 
            s(dateNum, k = 12, m = 2) + 
            s(locID, bs = "re", k = 131),
          data = evap_all, method = "REML", family = "gaussian")

summary(m2)

plot(m2)

gam.check(m2)

performance::compare_performance(m1, m2)

```

Get the random effects estimates of the plots

```{r predictions}
library(ggeffects)

m1re <- extract_random_effects(m1)

plotre <- m1re %>% filter(group_var == "locID")

ggplot(plotre, aes(group)) + 
  geom_pointrange(aes(y = value, ymin = lower_2.5, ymax = upper_97.5)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

which(levels(evap_all$dateFac) == median(evap_all$date))

newdata <- data.frame(locID = as.character(1:128),
                      dateFac = factor(median(evap_all$date)),
                      decTime = median(evap_all$decTime))

pred_evap <- predict(m1, newdata = newdata, se.fit = TRUE)

evap_std <- bind_cols(newdata, 
                      evap = pred_evap$fit,
                      evap_se = pred_evap$se.fit,
                      date = median(evap_all$date))

median(evap_all$date)

timepred <- ggpredict(m1, terms = c("decTime [6:15 by=0.5]", "locID [all]"),
                      condition = c(dateFac = "2016-07-03")) %>%
  mutate(locID = group)

allquads <- ggplot(evap_all %>% filter(locType == "plot"),
                   aes(decTime, evapRate_ng)) +
  geom_ribbon(data = timepred, 
              mapping = aes(x = x, ymin = conf.low, ymax = conf.high), inherit.aes = F,
              fill = "orange", alpha = 0.2) +
  geom_line(data = timepred, 
              mapping = aes(x = x, y = predicted), inherit.aes = F,
              color = "orange") +
  geom_point() + 
  geom_pointrange(data = evap_std, 
                  mapping = aes(decTime, 
                                y = evap, 
                                ymin = evap - evap_se, 
                                ymax = evap + evap_se),
                  inherit.aes = FALSE, color = "red", size = 0.1) +
  facet_wrap(~locID) + theme_article()

ggsave("allquads_time.pdf", plot = allquads, height = 16, width = 16, units = "in",
       dpi = 300)

# predict over days

median(evap_all$decTime)

datepred <- ggpredict(m1, terms = c("dateFac [all]", "locID [all]"),
                      condition = c(decTime = 10)) %>%
  mutate(locID = group) %>%
  mutate(date = as.Date(x))

allquads_day <- ggplot(evap_all %>% filter(locType == "plot"),
                   aes(date, evapRate_ng)) +
    geom_ribbon(data = datepred, 
              mapping = aes(x = date, ymin = conf.low, ymax = conf.high), inherit.aes = F,
              fill = "orange", alpha = 0.2) +
  geom_line(data = datepred, 
              mapping = aes(x = date, y = predicted), inherit.aes = F,
              color = "orange") +
  geom_point() + 
  geom_pointrange(data = evap_std, 
                  mapping = aes(date, 
                                y = evap, 
                                ymin = evap - evap_se, 
                                ymax = evap + evap_se),
                  inherit.aes = FALSE, color = "red", size = 0.1) +
  facet_wrap(~locID) + theme_article() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("allquads_date.pdf", plot = allquads_day, height = 16.2, width = 16, units = "in",
       dpi = 300)

```

# Look at the relationship between standardized evap and roya

```{r roya}
roya <- readRDS("roya_uniqueplants_20210505.rds")

roya_quad16 <- roya %>% filter(hojas != 0) %>%
  group_by(quadrat, year, date) %>% 
  summarize(roya.mn = mean(roya/hojas, na.rm = TRUE)) %>% 
  filter(date > 2016.5 & date < 2017.5)

ggplot(roya_quad16, aes(date, roya.mn, group = quadrat)) + geom_line()

roya_quadmax <- roya_quad16 %>% group_by(quadrat) %>%
  summarize(roya.max = max(roya.mn)) %>%
  mutate(locID = as.character(quadrat))

evaproya <- evap_std %>% left_join(roya_quadmax)

ggplot(evaproya, aes(evap, roya.max)) + geom_point() + theme_article() + 
  geom_smooth(method = "lm")

evaplm <- lm(roya.max ~ evap, data = evaproya)

summary(evaplm)

saveRDS(evap_std, "evap_std.rds")

```